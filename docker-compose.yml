services:
  # 1. NGINX
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - static_volume:/app/staticfiles
    depends_on:
      - web
      - frontend

  # 2. FRONTEND
  frontend:
    build: ./frontend
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "3000:3000"

  # 3. BACKEND (Django)
  web:
    build: ./backend
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000
    volumes:
      - ./backend:/app
      - /mnt/git-data:/git-data
      - static_volume:/app/staticfiles
    # üëá –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ—á–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –≤–Ω—É—Ç—Ä–∏ –ø–∞–ø–∫–∏ backend
    env_file:
      - ./backend/.env
    environment:
      # –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î (–æ–Ω–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç .env, –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è)
      - DB_HOST=34.41.176.77
      - DB_PORT=5432
      - DB_NAME=git_forum
      - DB_USER=mushi
      - DB_PASS=Mushi_zynq1
      - CELERY_BROKER_URL=redis://redis:6379/0
      # üëá –£–ë–†–ê–õ–ò N8N –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç—Å—é–¥–∞. 
      # Docker —Å–∞–º –≤–æ–∑—å–º–µ—Ç –∏—Ö –∏–∑ env_file –≤—ã—à–µ.
    depends_on:
      - redis

  # 4. WORKER
  worker:
    build: ./backend
    command: celery -A config worker -l info
    volumes:
      - ./backend:/app
      - /mnt/git-data:/git-data
    # üëá –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–æ—á–Ω—ã–π –ø—É—Ç—å
    env_file:
      - ./backend/.env
    environment:
      # –¢–æ–∂–µ —É–±—Ä–∞–ª–∏ –ª–∏—à–Ω–µ–µ, –æ—Å—Ç–∞–≤–∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      - DB_HOST=34.41.176.77
      - DB_PORT=5432
      - DB_NAME=git_forum
      - DB_USER=mushi
      - DB_PASS=Mushi_zynq1
      - CELERY_BROKER_URL=redis://redis:6379/0
    depends_on:
      - redis

  # 5. CELERY BEAT (–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏)
  celery-beat:
    build: ./backend
    command: celery -A config beat -l info
    volumes:
      - ./backend:/app
      - /mnt/git-data:/git-data
    env_file:
      - ./backend/.env
    environment:
      - DB_HOST=34.41.176.77
      - DB_PORT=5432
      - DB_NAME=git_forum
      - DB_USER=mushi
      - DB_PASS=Mushi_zynq1
      - CELERY_BROKER_URL=redis://redis:6379/0
    depends_on:
      - redis
      - web

  # 6. REDIS
  redis:
    image: redis:alpine

volumes:
  static_volume: